import tkinter as tk
from tkinter import filedialog
from functions.m3u import read_entries, write_override_yaml

class ChannelGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("StreamLedger Channel Selector")
        self.channels = []

        self.listbox = tk.Listbox(root, selectmode=tk.MULTIPLE, width=120)
        self.listbox.pack(fill=tk.BOTH, expand=True)

        btn_frame = tk.Frame(root)
        btn_frame.pack()

        tk.Button(btn_frame, text="Load M3U", command=self.load).pack(side=tk.LEFT)
        tk.Button(btn_frame, text="Save Selection", command=self.save).pack(side=tk.LEFT)

    def load(self):
        path = filedialog.askopenfilename(filetypes=[("M3U", "*.m3u")])
        if not path:
            return
        self.channels = read_entries(path)
        self.listbox.delete(0, tk.END)
        for ch in self.channels:
            label = f"{ch.get('tvg-id','')} | {ch['name']} | {ch.get('group','')}"
            self.listbox.insert(tk.END, label)

    def save(self):
        selected = [self.channels[i] for i in self.listbox.curselection()]
        write_override_yaml(selected, "config/manual_overrides.yaml")

if __name__ == "__main__":
    root = tk.Tk()
    ChannelGUI(root)
    root.mainloop()
